---
title: "Graphing_SYE"
author: "Alex Tidd"
format: html
---

```{r}
library(tidyverse)
library(ggplot2)
```

```{r}
## getting rankings to plug in
rankings_current = update_rankings_iter(schedule2025, "2025-02-21", X22Rankings, k = 100)
```

```{r}
schedule_current = schedule2025 |>
  filter(date == "2025-02-22") |>
  left_join(rankings_current, by = join_by(away_team == Team)) |>
  rename(away_elo = rating) |>
  left_join(rankings_current, by = join_by(home_team == Team)) |>
  rename(home_elo = rating) |>
  mutate(outcome_away = abs(outcome - 1)) |> 
  mutate(exp_home = 1/(1 + 10^((away_elo - home_elo)/400))) |>
  mutate(exp_away = 1/(1 + 10^((home_elo - away_elo)/400))) |>
  mutate(elo_new_home = home_elo + 100 * (outcome - exp_home)) |>
  mutate(elo_new_away = away_elo + 100 *(outcome_away - exp_away))
```

```{r}
schedule_update <- function(season, game_date, ratings, k = 20){
  ## Filters schedule to a specific date
  elo_ratings_update <- season |> filter(date == game_date) |>
    ## Joins the Elo ratings from our rating file to the schedule file. Puts updated ratings in the schedule
    left_join(ratings, by = join_by(away_team == Team)) |>
    rename(away_elo = rating) |>  
    ## Updates ratings for home team in the schedule file
    left_join(ratings, by = join_by(home_team == Team)) |>
    rename(home_elo = rating) |>
    ## Creating an away team outcome variable. Opposite of home team or same if tie.
    mutate(outcome_away = abs(outcome - 1)) |> 
    ## Calculating expected outcome variable for home and away team
    mutate(exp_home = 1/(1 + 10^((away_elo - home_elo)/400))) |>
    mutate(exp_away = 1/(1 + 10^((home_elo - away_elo)/400))) |>
    ## Using expected outcome variable to generate new Elo ratings based on actual outcome and expected outcome
    mutate(elo_new_home = home_elo + k*(outcome - exp_home)) |>
    mutate(elo_new_away = away_elo + k*(outcome_away - exp_away))
  
  ranked_home <- left_join(ratings, elo_ratings_update, by = join_by(Team == home_team)) |>
    relocate(elo_new_home) |>
    mutate(rating = if_else(!is.na(elo_new_home),
                            true = elo_new_home,
                            false = rating)) |>
    select(Team, rating)
  
  ratings <- left_join(ranked_home, elo_ratings_update, by = join_by(Team == away_team)) |>
    relocate(elo_new_away) |>
    mutate(rating = if_else(!is.na(elo_new_away),
                            true = elo_new_away,
                            false = rating)) |>
    select(Team, rating)
  
  ## Puts updated Elo ratings into our ratings file for home team
  ##ratings$rating = replace(ratings$rating, ratings$Team %in% elo_ratings_update$home_team, elo_ratings_update$elo_new_home)
  
  ## Puts updated Elo ratings into our ratings file for away team
  ##ratings$rating = replace(ratings$rating, ratings$Team %in% elo_ratings_update$away_team, elo_ratings_update$elo_new_away)
  
  return(ratings)
}
```

```{r}
try2 = schedule_update(schedule2025, "2025-02-21", X22Rankings, k = 100)
```


```{r}
ggplot(data = schedule_current, aes(x = exp_home,
                                    y = outcome)) +
  geom_point()
```

